<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">

<html xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>DICOM Configuration - Î¼PACS</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="./../static/mupacs.css" th:href="@{/mupacs.css}"/>
</head>

<body>
<div class="container-fluid">

    <div th:replace="~{fragments/menu :: menu}">MENU</div>

    <h2>DICOM Service Configuration</h2>

    <!-- Service Status Panel -->
    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-info-sign"></span> Service Status
            </h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>Status:</dt>
                        <dd>
                            <span class="label" th:classappend="${config.statusClass}" th:text="${config.statusLabel}">
                                Running
                            </span>
                        </dd>
                        <dt>Device Name:</dt>
                        <dd th:text="${config.deviceName}">MUPACS-DEVICE</dd>
                        <dt>Registered Services:</dt>
                        <dd th:text="${config.registeredServices}">3</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info dicom-config-info-alert">
                        <strong>Service Information:</strong><br/>
                        The DICOM service is configured to accept connections on the specified port
                        and provides C-ECHO, C-FIND, and C-STORE operations.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Configuration Panel -->
    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-globe"></span> Network Configuration
            </h3>
        </div>
        <div class="panel-body">
            <table class="table table-bordered dicom-config-network-table">
                <tbody>
                    <tr>
                        <th>Application Entity Title (AE Title)</th>
                        <td>
                            <code th:text="${config.aeTitle}">MUPACS</code>
                        </td>
                    </tr>
                    <tr>
                        <th>Hostname</th>
                        <td>
                            <code th:text="${config.host}">localhost</code>
                        </td>
                    </tr>
                    <tr>
                        <th>Port</th>
                        <td>
                            <code th:text="${config.port}">11112</code>
                        </td>
                    </tr>
                    <tr>
                        <th>Connection String</th>
                        <td>
                            <code th:text="${config.connectionString}">localhost:11112</code>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Remote AET Management Panel -->
    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-transfer"></span> Remote Application Entity Titles (AETs)
            </h3>
        </div>
        <div class="panel-body">
            <!-- Success/Error Messages -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <span class="glyphicon glyphicon-ok-sign"></span>
                <span th:text="${successMessage}">Success message</span>
            </div>

            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <span class="glyphicon glyphicon-exclamation-sign"></span>
                <span th:text="${errorMessage}">Error message</span>
            </div>

            <p>Configure remote DICOM nodes that this PACS system can communicate with.</p>

            <!-- Add New AET Form -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <span class="glyphicon glyphicon-plus"></span> Add New AET
                    </h4>
                </div>
                <div class="panel-body">
                    <form action="#" th:action="@{/dicomconfig/aet/add}" method="post" class="form-inline">
                        <div class="form-group">
                            <label for="aetInput" class="sr-only">AE Title</label>
                            <input type="text" class="form-control dicom-aet-input-aet" id="aetInput" name="aet"
                                   placeholder="AE Title (e.g., REMOTE_PACS)" required="required"/>
                        </div>
                        <div class="form-group dicom-aet-form-group">
                            <label for="hostInput" class="sr-only">Host</label>
                            <input type="text" class="form-control dicom-aet-input-host" id="hostInput" name="host"
                                   placeholder="Host (e.g., 192.168.1.100)" required="required"/>
                        </div>
                        <div class="form-group dicom-aet-form-group">
                            <label for="portInput" class="sr-only">Port</label>
                            <input type="number" class="form-control dicom-aet-input-port" id="portInput" name="port"
                                   placeholder="Port" min="1" max="65535" required="required"/>
                        </div>
                        <button type="submit" class="btn btn-primary dicom-aet-add-button">
                            <span class="glyphicon glyphicon-plus"></span> Add AET
                        </button>
                    </form>
                </div>
            </div>

            <!-- AET List Table -->
            <table class="table table-striped table-bordered dicom-aet-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>AE Title</th>
                        <th>Host</th>
                        <th>Port</th>
                        <!-- <th>Connection String</th> -->
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${aets.isEmpty()}">
                        <td colspan="6" class="text-center text-muted">
                            <em>No remote AETs configured. Add one using the form above.</em>
                        </td>
                    </tr>
                    <tr th:each="aet : ${aets}">
                        <td th:text="${aet.id}">1</td>
                        <td>
                            <code th:text="${aet.aet}">REMOTE_PACS</code>
                        </td>
                        <td th:text="${aet.host}">192.168.1.100</td>
                        <td th:text="${aet.port}">104</td>
                        <!--
                        <td>
                            <code th:text="${aet.connectionString}">REMOTE_PACS@192.168.1.100:104</code>
                        </td>
                        -->
                        <td>
                            <button type="button" class="btn btn-sm btn-info"
                                    th:attr="data-id=${aet.id},data-aet=${aet.aet}"
                                    onclick="echoAetFromData(this)"
                                    title="Test connectivity with C-ECHO">
                                <span class="glyphicon glyphicon-flash"></span> Echo
                            </button>
                            <button type="button" class="btn btn-sm btn-warning"
                                    th:attr="data-id=${aet.id},data-aet=${aet.aet},data-host=${aet.host},data-port=${aet.port}"
                                    onclick="editAetFromData(this)">
                                <span class="glyphicon glyphicon-pencil"></span> Edit
                            </button>
                            <button type="button" class="btn btn-sm btn-danger"
                                    th:attr="data-id=${aet.id},data-aet=${aet.aet}"
                                    onclick="deleteAetFromData(this)">
                                <span class="glyphicon glyphicon-trash"></span> Delete
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Supported Services Panel -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-list"></span> Supported DICOM Services
            </h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="panel panel-info">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <span class="glyphicon glyphicon-ok-circle"></span> C-ECHO SCP
                            </h4>
                        </div>
                        <div class="panel-body">
                            <p><strong>Verification Service</strong></p>
                            <p class="text-muted">
                                Responds to DICOM echo requests to verify connectivity.
                                Used for testing network connections.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="panel panel-success">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <span class="glyphicon glyphicon-search"></span> C-FIND SCP
                            </h4>
                        </div>
                        <div class="panel-body">
                            <p><strong>Query Service</strong></p>
                            <p class="text-muted">
                                Allows querying of patient, study, and series information
                                stored in the archive.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="panel panel-warning">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <span class="glyphicon glyphicon-save"></span> C-STORE SCP
                            </h4>
                        </div>
                        <div class="panel-body">
                            <p><strong>Storage Service</strong></p>
                            <p class="text-muted">
                                Accepts and stores DICOM images and related data
                                from remote systems.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Instructions Panel -->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-console"></span> Connection Instructions
            </h3>
        </div>
        <div class="panel-body">
            <h4>Connecting from DICOM Clients</h4>
            <p>To connect to this PACS system from a DICOM client, use the following parameters:</p>

            <div class="well">
                <dl class="dl-horizontal">
                    <dt>Called AE Title:</dt>
                    <dd><code th:text="${config.aeTitle}">MUPACS</code></dd>
                    <dt>Hostname:</dt>
                    <dd><code th:text="${config.host}">localhost</code></dd>
                    <dt>Port:</dt>
                    <dd><code th:text="${config.port}">11112</code></dd>
                </dl>
            </div>

            <h4>Example: dcm4che echoscu</h4>
            <pre><code>echoscu -c <span th:text="${config.aeTitle}">MUPACS</span>@<span th:text="${config.host}">localhost</span>:<span th:text="${config.port}">11112</span></code></pre>

            <h4>Example: dcm4che storescu</h4>
            <pre><code>storescu -c <span th:text="${config.aeTitle}">MUPACS</span>@<span th:text="${config.host}">localhost</span>:<span th:text="${config.port}">11112</span> /path/to/dicom/files</code></pre>
        </div>
    </div>


    <!-- Edit AET Modal -->
    <div class="modal fade" id="editAetModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="editAetForm" method="post">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-pencil"></span> Edit AET
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="editAetInput">AE Title</label>
                            <input type="text" class="form-control" id="editAetInput" name="aet" required="required"/>
                        </div>
                        <div class="form-group">
                            <label for="editHostInput">Host</label>
                            <input type="text" class="form-control" id="editHostInput" name="host" required="required"/>
                        </div>
                        <div class="form-group">
                            <label for="editPortInput">Port</label>
                            <input type="number" class="form-control" id="editPortInput" name="port"
                                   min="1" max="65535" required="required"/>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="glyphicon glyphicon-save"></span> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteAetModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="deleteAetForm" method="post">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-warning-sign"></span> Confirm Delete
                        </h4>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete the AET <strong id="deleteAetName"></strong>?</p>
                        <p class="text-danger">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                            <span class="glyphicon glyphicon-trash"></span> Delete
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function echoAetFromData(button) {
            var id = button.getAttribute('data-id');

            // Create and submit a form to trigger C-ECHO
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/dicomconfig/aet/echo/' + id;
            document.body.appendChild(form);
            form.submit();
        }

        function editAetFromData(button) {
            var id = button.getAttribute('data-id');
            var aet = button.getAttribute('data-aet');
            var host = button.getAttribute('data-host');
            var port = button.getAttribute('data-port');

            document.getElementById('editAetForm').action = '/dicomconfig/aet/edit/' + id;
            document.getElementById('editAetInput').value = aet;
            document.getElementById('editHostInput').value = host;
            document.getElementById('editPortInput').value = port;
            $('#editAetModal').modal('show');
        }

        function deleteAetFromData(button) {
            var id = button.getAttribute('data-id');
            var aet = button.getAttribute('data-aet');

            document.getElementById('deleteAetForm').action = '/dicomconfig/aet/delete/' + id;
            document.getElementById('deleteAetName').textContent = aet;
            $('#deleteAetModal').modal('show');
        }
    </script>

    <div th:replace="~{fragments/footer :: footer}">EMPTY FOOTER</div>

</div>
</body>
</html>

